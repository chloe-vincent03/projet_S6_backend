import{r as _,l as T,x as O,c as f,o as c,a as t,q as S,y as z,z as D,A as N,v as g,t as j,b,B as V,w as k,n as q,d as $}from"./FsFn14e0.js";import{_ as U}from"./2d5tmkDm.js";/* empty css        */import{u as X}from"./LQRTUvHo.js";import{u as F}from"./41ABSLID.js";import"./BJ2ClxiI.js";const G=["src"],Y={key:0,class:"absolute inset-0 flex items-center justify-center bg-black/10 backdrop-blur-sm z-20"},H=500,W={__name:"ScratchReveal",props:{inkLayer:{type:String,required:!0},watercolorLayer:{type:String,required:!0},brushSize:{type:Number,default:50}},emits:["progress","complete"],setup(h,{emit:u}){const p=h,i=_(null),o=_(null),m=_(!1);let a=null,v=null;const x=()=>{v=new Image,v.crossOrigin="Anonymous",v.src=p.watercolorLayer,v.onload=()=>{m.value=!0,n()}},n=()=>{if(!o.value||!i.value)return;const e=o.value,l=i.value;e.width=l.clientWidth,e.height=l.clientHeight,a=e.getContext("2d",{willReadFrequently:!0})},w=e=>{if(!m.value||!a||!v)return;const l=o.value.getBoundingClientRect(),r=e.clientX-l.left,y=e.clientY-l.top;a.save(),a.beginPath(),a.arc(r,y,p.brushSize,0,Math.PI*2),a.clip(),a.drawImage(v,0,0,o.value.width,o.value.height),a.restore(),E()},L=e=>{e.preventDefault();const l=e.touches[0];w({clientX:l.clientX,clientY:l.clientY})},C=u;let d=0;const E=()=>{const e=Date.now();e-d>H&&(B(),d=e)},B=()=>{if(!a||!o.value)return;const e=o.value.width,l=o.value.height,y=a.getImageData(0,0,e,l).data;let I=0;y.length/4;const M=32;let P=0;for(let R=3;R<y.length;R+=4*M)P++,y[R]>0&&I++;const A=Math.round(I/P*100);C("progress",A),A>85&&C("complete",!0)};let s;return T(()=>{x(),i.value&&(s=new ResizeObserver(()=>{n()}),s.observe(i.value))}),O(()=>{s&&s.disconnect()}),(e,l)=>(c(),f("div",{ref_key:"containerRef",ref:i,class:"relative w-full h-full overflow-hidden cursor-crosshair touch-none"},[t("img",{src:h.inkLayer,alt:"Background",class:z(["absolute inset-0 w-full h-full object-cover pointer-events-none select-none transition-filter duration-300",{grayscale:h.inkLayer===h.watercolorLayer}])},null,10,G),t("canvas",{ref_key:"canvasRef",ref:o,class:"absolute inset-0 w-full h-full z-10",onMousemove:w,onTouchmove:L},null,544),m.value?S("",!0):(c(),f("div",Y,[...l[0]||(l[0]=[t("span",{class:"text-white font-medium bg-black/50 px-3 py-1 rounded-full text-sm"},"Chargement...",-1)])]))],512))}},J={key:0,class:"flex items-center justify-center h-screen"},K={key:1,class:"flex flex-col items-center justify-center h-screen text-red-500"},Q={class:"text-sm mt-2"},Z={key:2},ee={class:"relative w-full h-screen"},te={key:0,class:"w-full h-full relative z-10"},se=["src"],oe={class:"container mx-auto px-6 py-24 max-w-4xl",id:"content-start"},le={class:"flex flex-col gap-8 text-center"},ne={class:"text-5xl font-serif text-[#2C3E50] leading-tight"},re={class:"text-xl text-stone-600 leading-loose font-light"},ae={class:"mt-24 mb-12 w-full max-w-4xl mx-auto flex flex-col items-center gap-12 relative z-50"},ie={class:"p-10 glass-panel rounded-[3rem] text-center max-w-4xl w-full"},ce={key:0,class:"grid grid-cols-1 md:grid-cols-2 gap-6"},ue={key:1,class:"flex flex-col gap-4 items-center mt-6"},de={class:"flex gap-4"},xe={__name:"index",async setup(h){let u,p;const i=q(),o=X("auth_token"),{data:m,pending:a,error:v}=([u,p]=D(()=>F(`${i.public.apiBase}/places`,"$orW8SXrfeA")),u=await u,p(),u),{data:x}=([u,p]=D(()=>F(`${i.public.apiBase}/enigmas`,"$Esc5XvxuRO")),u=await u,p(),u),n=N(()=>m.value?.[0]),w=N(()=>x.value?.find(s=>s.id==="enigma_001")||x.value?.find(s=>s.id==="1")||x.value?.[0]),L=_(!1),C=async()=>{if(o.value)try{const s=await fetch(`${i.public.apiBase}/user/profile`,{headers:{Authorization:`Bearer ${o.value}`}});if(s.ok){const e=await s.json();e.unlockedFragments&&w.value&&e.unlockedFragments.some(r=>r.fragmentId===w.value.reward.fragment_id)&&(L.value=!0)}}catch(s){console.error(s)}},d=_(!1),E=async()=>{if(o.value&&n.value)try{const s=await fetch(`${i.public.apiBase}/user/profile`,{headers:{Authorization:`Bearer ${o.value}`}});s.ok&&(await s.json()).progress?.some(r=>r.placeId===n.value._id&&r.isCompleted)&&(console.log("Place already discovered, auto-unlocking."),d.value=!0)}catch(s){console.error("Error checking progress:",s)}};T(()=>{E(),C()});const B=async()=>{if(!d.value)if(d.value=!0,o.value&&n.value){console.log("Attempting to save progress for place:",n.value._id);try{const s=await fetch(`${i.public.apiBase}/user/progress`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.value}`},body:JSON.stringify({placeId:n.value._id})});s.ok?console.log("Progress saved successfully!"):console.error("Failed to save progress:",await s.text())}catch(s){console.error("Erreur sauvegarde progression",s)}}else console.warn("User not logged in, progress will not be saved permanently.")};return(s,e)=>{const l=W,r=U;return c(),f("div",{class:z(["min-h-screen bg-stone-50 transition-all duration-1000",{"h-screen overflow-hidden":!d.value}])},[g(a)?(c(),f("div",J,[...e[0]||(e[0]=[t("p",{class:"text-stone-500 animate-pulse"},"Chargement de la ville...",-1)])])):g(v)?(c(),f("div",K,[e[1]||(e[1]=t("p",{class:"font-bold"},"Erreur de chargement",-1)),t("p",Q,j(g(v).message),1)])):g(m)&&g(m).length>0?(c(),f("div",Z,[t("section",ee,[e[5]||(e[5]=t("div",{class:"absolute inset-0 z-20 flex items-center justify-center pointer-events-none mix-blend-difference"},[t("h1",{class:"text-5xl md:text-7xl font-serif font-bold text-white tracking-wider text-center px-4"}," Réenchanter le Monde ")],-1)),d.value?(c(),f("img",{key:1,src:n.value.watercolorLayer,alt:"Révélé",class:"absolute inset-0 w-full h-full object-cover z-10 transition-opacity duration-1000 ease-in-out"},null,8,se)):(c(),f("div",te,[b(l,{inkLayer:n.value.inkLayer,watercolorLayer:n.value.watercolorLayer,class:"w-full h-full",onComplete:B},null,8,["inkLayer","watercolorLayer"])])),t("div",{class:z(["absolute bottom-12 left-0 w-full text-center pointer-events-none z-20 flex flex-col items-center gap-4 transition-opacity duration-500",{"opacity-0":d.value}])},[e[3]||(e[3]=t("div",{class:"px-6 py-3 bg-black/40 backdrop-blur-md rounded-full text-white/90 font-medium text-lg shadow-sm border border-white/10"}," ✨ Coloriez pour découvrir ✨ ",-1)),g(o)?S("",!0):(c(),V(r,{key:0,to:"/login",class:"pointer-events-auto text-white/80 text-sm hover:text-white hover:underline transition-colors font-medium shadow-black drop-shadow-md"},{default:k(()=>[...e[2]||(e[2]=[$(" Déjà un compte ? Se connecter ",-1)])]),_:1}))],2),t("div",{class:z(["absolute bottom-12 left-0 w-full flex justify-center pointer-events-none z-30 transition-all duration-700 transform",d.value?"opacity-100 translate-y-0":"opacity-0 translate-y-10"])},[...e[4]||(e[4]=[t("div",{class:"animate-bounce p-2 bg-white/20 backdrop-blur-sm rounded-full"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"text-white"},[t("path",{d:"M12 5v14"}),t("path",{d:"m19 12-7 7-7-7"})])],-1)])],2)]),t("section",oe,[t("article",le,[e[6]||(e[6]=t("span",{class:"text-sm font-bold uppercase tracking-widest text-stone-500"},"Chapitre 1",-1)),t("h2",ne,j(n.value.title),1),e[7]||(e[7]=t("div",{class:"w-24 h-1 bg-stone-200 mx-auto my-4"},null,-1)),t("p",re,j(n.value.description),1)]),t("div",ae,[t("div",ie,[e[13]||(e[13]=t("div",{class:"mb-10 max-w-2xl mx-auto"},[t("h3",{class:"text-2xl font-serif text-[#2C3E50] font-bold mb-4"},"La Ville Lente"),t("p",{class:"text-stone-600 text-lg leading-relaxed"}," En découvrant les lieux de la ville, vous dévoilez son histoire et participez à sa création. Chaque secret révélé ajoute une pierre à l'édifice. ")],-1)),g(o)?(c(),f("div",ce,[b(r,{to:"/map",class:"group relative overflow-hidden bg-white p-8 rounded-3xl shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center gap-6 text-center h-72"},{default:k(()=>[...e[8]||(e[8]=[t("div",null,[t("h4",{class:"text-2xl font-serif font-bold text-[#2C3E50] mb-2"},"La Carte"),t("p",{class:"text-stone-500 font-light"},"Explorez les lieux et suivez votre progression.")],-1)])]),_:1}),b(r,{to:"/grimoire",class:"group relative overflow-hidden bg-white p-8 rounded-3xl shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center gap-6 text-center h-72"},{default:k(()=>[...e[9]||(e[9]=[t("div",null,[t("h4",{class:"text-2xl font-serif font-bold text-[#2C3E50] mb-2"},"Le Grimoire"),t("p",{class:"text-stone-500 font-light"},"Résolvez les énigmes et trouvez les totems.")],-1)])]),_:1})])):(c(),f("div",ue,[e[12]||(e[12]=t("p",{class:"text-sm text-stone-500 italic"},"Connectez-vous pour sauvegarder votre progression.",-1)),t("div",de,[b(r,{to:"/login",class:"px-6 py-2 border border-[#2C3E50] text-[#2C3E50] rounded-full font-bold hover:bg-stone-50 transition-colors"},{default:k(()=>[...e[10]||(e[10]=[$(" Connexion ",-1)])]),_:1}),b(r,{to:"/register",class:"px-6 py-2 bg-[#2C3E50] text-white rounded-full font-bold hover:bg-[#34495E] transition-colors"},{default:k(()=>[...e[11]||(e[11]=[$(" Inscription ",-1)])]),_:1})])]))])])])])):S("",!0)],2)}}};export{xe as default};
