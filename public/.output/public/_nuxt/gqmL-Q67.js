import{g as B,j as V,r as d,k as G,l as S,m as D,n as H,p as O,c as n,o as l,a as e,q as f,t as h,b as F,w as U,d as Z,F as A,s as z,v as W,_ as J}from"./17CJ-4L8.js";import{_ as K}from"./CMZabeNq.js";import{u as Q}from"./HbBEbhl-.js";import{u as X}from"./DRs_EN8N.js";import"./BJ2ClxiI.js";const Y={class:"flex flex-col md:flex-row h-[calc(100vh-5rem)] w-full bg-[#e9ecf5]"},ee={class:"w-full md:w-80 h-[40vh] md:h-full bg-white shadow-xl z-20 flex flex-col border-t md:border-t-0 md:border-r border-stone-200 order-2 md:order-1"},te={class:"p-6 border-b border-stone-100 bg-stone-50 relative"},oe={key:0,class:"text-xs text-stone-500 mt-1"},se={key:1,class:"mt-6"},re={class:"flex-1 overflow-y-auto p-4 space-y-4"},ae={key:0,class:"space-y-4"},ne={key:1,class:"text-center py-10 text-stone-500"},le=["onClick"],ie=["src","alt"],ce={class:"flex-1 min-w-0"},de={class:"font-bold text-[#2C3E50] text-sm truncate"},ue={class:"text-xs text-gray-500 line-clamp-2 mt-0.5"},me={class:"w-full md:flex-1 relative h-[60vh] md:h-full bg-[#e9ecf5] order-1 md:order-2"},pe={key:0,class:"absolute top-20 left-1/2 -translate-x-1/2 z-[1000] bg-white px-6 py-4 rounded-xl shadow-xl text-center"},ve={class:"text-gray-600 mb-2"},fe="https://res.cloudinary.com/dveki8qer/image/upload/v1768829196/Gemini_Generated_Image_2pq9hf2pq9hf2pq9_v1c0fi.png",he=2e3,xe=1500,_e=B({__name:"map",setup(be){const I=H(),T=Q("auth_token"),P=V(),u=d(null),m=d(!0),p=d(""),c=d([]),x=d(null),{totemMetadata:_}=X(),b=G(),j=d(null),M=o=>o.coordinates&&o.coordinates.x&&o.coordinates.y?o.coordinates:{x:1e3,y:750};return S(async()=>{if(!T.value){P.push("/login");return}try{const o=await D(()=>import("./CjPBq9Bq.js").then(t=>t.l),[],import.meta.url),s=await fetch(`${I.public.apiBase}/user/profile`,{method:"GET",headers:{Authorization:`Bearer ${T.value}`,Accept:"application/json"}});if(!s.ok)throw new Error("Impossible de charger le profil");const g=await s.json(),r=await fetch(`${I.public.apiBase}/places`);if(!r.ok)throw new Error("Impossible de charger les lieux");const y=await r.json(),$=g.progress.filter(t=>t.isCompleted).map(t=>t.placeId);c.value=y.filter(t=>$.includes(t._id));const w=y.filter(t=>!$.includes(t._id));if(w.length>0&&(w.sort((t,v)=>(t.order||99)-(v.order||99)),x.value=w[0]),await O(),u.value){const t=o.map(u.value,{crs:o.CRS.Simple,minZoom:-2,maxZoom:2,zoomSnap:.5});j.value=t;const v=[[0,0],[xe,he]],q=9,L=c.value.length,N=Math.min(L/q,1);u.value&&u.value.style.setProperty("--map-saturation",`${N}`);const ye=o.imageOverlay(fe,v,{className:"map-procedure-layer"}).addTo(t);t.fitBounds(v),c.value.forEach(a=>{const i=M(a);if(i){const C=`
            <div class="text-center">
              <h3 class="font-bold text-[#2C3E50] mb-2">${a.title}</h3>
              <img src="${a.watercolorLayer}" alt="${a.title}" class="w-24 h-24 object-cover rounded-lg mx-auto mb-2 shadow-sm" />
              <p class="text-xs text-gray-600 line-clamp-2">${a.description}</p>
            </div>
          `,E=o.divIcon({className:"custom-emoji-marker",html:'<div style="font-size: 2rem; transform: translate(-50%, -50%); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));">üìç</div>',iconSize:[0,0],iconAnchor:[0,10]});o.marker([i.y,i.x],{icon:E}).addTo(t).bindPopup(C)}}),Object.entries(_).forEach(([a,i])=>{if(i.coordinates){const C=o.divIcon({className:"totem-pillar-marker",html:'<div style="font-size: 3rem; transform: translate(-50%, -50%);">üèõÔ∏è</div>',iconSize:[0,0],iconAnchor:[0,20]}),E=o.marker([i.coordinates.y,i.coordinates.x],{icon:C}).addTo(t),R=`
                <div class="text-center p-2">
                   <h3 class="font-bold text-amber-600 mb-1 text-lg">${i.name}</h3>
                   <p class="text-xs text-gray-500 mb-3 italic">D√©couvrez les secrets de ce totem.</p>
                   <button onclick="window.location.href='/grimoire?totemId=${a}'" class="px-4 py-2 bg-amber-500 text-white rounded-full font-bold text-xs hover:bg-amber-600 shadow-md transition-all">
                     üìñ Consulter le Grimoire
                   </button>
                </div>
              `;E.bindPopup(R)}});const k=Array.isArray(b.query.focusTotem)?b.query.focusTotem[0]:b.query.focusTotem;if(k&&_[k]){const a=_[k].coordinates;a&&setTimeout(()=>{t.flyTo([a.y,a.x],1.5,{duration:2})},500)}c.value.length===0&&(p.value="Aucun lieu d√©couvert pour le moment.")}}catch(o){console.error("Erreur map:",o),p.value=o.message||"Une erreur est survenue"}finally{m.value=!1}}),(o,s)=>{const g=K;return l(),n("div",Y,[e("aside",ee,[e("div",te,[s[1]||(s[1]=e("h1",{class:"text-xl font-serif text-[#2C3E50] font-bold"},"Mes D√©couvertes",-1)),m.value?f("",!0):(l(),n("p",oe,h(c.value.length)+" lieux r√©v√©l√©s",1)),x.value?(l(),n("div",se,[F(g,{to:`/discovery/${x.value._id}`,class:"block w-full py-3 px-4 bg-[#2C3E50] text-white text-center rounded-xl font-bold hover:bg-[#34495E] hover:scale-[1.02] transition-all shadow-md"},{default:U(()=>[...s[0]||(s[0]=[Z(" ‚ú® Continuer l'aventure ",-1)])]),_:1},8,["to"])])):f("",!0)]),e("div",re,[m.value?(l(),n("div",ae,[(l(),n(A,null,z(3,r=>e("div",{key:r,class:"bg-stone-50 rounded-xl p-3 animate-pulse flex items-center gap-3"},[...s[2]||(s[2]=[e("div",{class:"w-16 h-16 bg-stone-200 rounded-lg"},null,-1),e("div",{class:"flex-1 space-y-2"},[e("div",{class:"h-4 bg-stone-200 rounded w-3/4"}),e("div",{class:"h-3 bg-stone-200 rounded w-1/2"})],-1)])])),64))])):c.value.length===0?(l(),n("div",ne,[...s[3]||(s[3]=[e("p",{class:"mb-2"},"üëª",-1),e("p",{class:"text-sm"},"Votre carte est vide...",-1),e("p",{class:"text-xs mt-2"},"Explorez la ville pour remplir votre carnet !",-1)])])):f("",!0),(l(!0),n(A,null,z(c.value,r=>(l(),n("div",{key:r._id,onClick:y=>W(P).push(`/discovery/${r._id}`),class:"group bg-white border border-stone-100 rounded-xl p-3 hover:shadow-md transition-all cursor-pointer flex gap-3 items-center"},[e("img",{src:r.watercolorLayer,alt:r.title,class:"w-16 h-16 object-cover rounded-lg bg-stone-100 shadow-sm"},null,8,ie),e("div",ce,[e("h3",de,h(r.title),1),e("p",ue,h(r.description),1)])],8,le))),128))])]),e("div",me,[p.value&&!m.value?(l(),n("div",pe,[e("p",ve,h(p.value),1)])):f("",!0),e("div",{ref_key:"mapContainer",ref:u,class:"w-full h-full z-0 outline-none"},null,512)])])}}}),Te=J(_e,[["__scopeId","data-v-d99a6f59"]]);export{Te as default};
